<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Learn2Teach</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <nav class="container">
            <a href="/" class="logo">Learn2Teach</a>
            <ul class="nav-links">
                <li><a href="/dashboard">Dashboard</a></li>
                <li><a href="/skills">Browse Skills</a></li>
                <li><a href="/profile">Profile</a></li>
                <li><button onclick="logout()" class="btn btn-secondary">Logout</button></li>
            </ul>
        </nav>
    </header>

    <div class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1>My Dashboard</h1>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('my-skills')">My Skills</button>
                <button class="tab" onclick="showTab('sessions')">My Sessions</button>
            </div>

            <div id="alert-container"></div>

            <div id="my-skills-tab" class="tab-content">
                <div style="margin-bottom: 24px;">
                    <button class="btn btn-primary" onclick="openAddSkillModal()">Add New Skill</button>
                </div>

                <div class="skills-grid" id="my-skills-list">
                    <div class="empty-state">
                        <h3>Loading your skills...</h3>
                    </div>
                </div>
            </div>

            <div id="sessions-tab" class="tab-content" style="display: none;">
                <div id="sessions-list">
                    <div class="empty-state">
                        <h3>Loading your sessions...</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="add-skill-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Skill</h2>
                <button class="modal-close" onclick="closeAddSkillModal()">&times;</button>
            </div>
            <form id="add-skill-form">
                <div class="form-group">
                    <label for="skill_name">Skill Name</label>
                    <input type="text" id="skill_name" required>
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" required>
                        <option value="">Select Category</option>
                        <option value="Programming">Programming</option>
                        <option value="Languages">Languages</option>
                        <option value="Arts & Design">Arts & Design</option>
                        <option value="Music">Music</option>
                        <option value="Business">Business</option>
                        <option value="Fitness">Fitness</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="skill_type">I want to</label>
                    <select id="skill_type" required>
                        <option value="teaching">Teach this skill</option>
                        <option value="learning">Learn this skill</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" required></textarea>
                </div>
                <div class="form-group">
                    <label for="hourly_rate">Hourly Rate ($) - Set to 0 for free</label>
                    <input type="number" id="hourly_rate" min="0" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="accepts_exchange">
                        Accept skill exchange (trade skills instead of payment)
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Add Skill</button>
            </form>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').style.display = 'block';

            if (tabName === 'sessions') {
                loadSessions();
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        function openAddSkillModal() {
            document.getElementById('add-skill-modal').classList.add('active');
        }

        function closeAddSkillModal() {
            document.getElementById('add-skill-modal').classList.remove('active');
            document.getElementById('add-skill-form').reset();
        }

        document.getElementById('add-skill-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const skillData = {
                skill_name: document.getElementById('skill_name').value,
                category: document.getElementById('category').value,
                skill_type: document.getElementById('skill_type').value,
                description: document.getElementById('description').value,
                hourly_rate: parseFloat(document.getElementById('hourly_rate').value),
                accepts_exchange: document.getElementById('accepts_exchange').checked
            };

            try {
                const response = await fetch('/api/skills', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(skillData)
                });

                const data = await response.json();

                if (data.success) {
                    closeAddSkillModal();
                    loadMySkills();
                    showAlert('Skill added successfully!', 'success');
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to add skill', 'error');
            }
        });

        async function loadMySkills() {
            try {
                const response = await fetch('/api/skills');
                const data = await response.json();

                if (data.success) {
                    const mySkillsList = document.getElementById('my-skills-list');

                    if (data.skills.length === 0) {
                        mySkillsList.innerHTML = '<div class="empty-state"><h3>No skills yet</h3><p>Add your first skill to get started!</p></div>';
                        return;
                    }

                    mySkillsList.innerHTML = data.skills.map(skill => `
                        <div class="skill-card">
                            <span class="skill-badge badge-${skill.skill_type}">${skill.skill_type}</span>
                            <h3>${skill.skill_name}</h3>
                            <p class="skill-location">${skill.category}</p>
                            <p class="skill-description">${skill.description}</p>
                            <div class="skill-footer">
                                <div class="skill-price">
                                    ${skill.hourly_rate > 0 ? '$' + skill.hourly_rate + '/hr' : 'Free'}
                                    ${skill.accepts_exchange ? ' or Exchange' : ''}
                                </div>
                                <button class="btn btn-danger" onclick="deleteSkill('${skill.id}')">Delete</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load skills:', error);
            }
        }

        async function deleteSkill(skillId) {
            if (!confirm('Are you sure you want to delete this skill?')) return;

            try {
                const response = await fetch(`/api/skills/${skillId}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    loadMySkills();
                    showAlert('Skill deleted successfully', 'success');
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to delete skill', 'error');
            }
        }

        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const data = await response.json();

                if (data.success) {
                    const sessionsList = document.getElementById('sessions-list');

                    if (data.sessions.length === 0) {
                        sessionsList.innerHTML = '<div class="empty-state"><h3>No sessions yet</h3><p>Book a session to get started!</p></div>';
                        return;
                    }

                    sessionsList.innerHTML = data.sessions.map(session => `
                        <div class="session-card">
                            <div class="session-header">
                                <div>
                                    <h3>${session.skill.skill_name}</h3>
                                    <p style="color: var(--text-light);">
                                        Teacher: ${session.teacher.full_name} | Learner: ${session.learner.full_name}
                                    </p>
                                    <p style="margin-top: 8px;">
                                        <strong>Date:</strong> ${new Date(session.session_date).toLocaleString()}<br>
                                        <strong>Duration:</strong> ${session.duration_hours} hours<br>
                                        <strong>Location:</strong> ${session.location}
                                    </p>
                                </div>
                                <span class="status-badge status-${session.status}">${session.status}</span>
                            </div>
                            ${session.notes ? `<p style="margin-top: 12px; color: var(--text-light);">${session.notes}</p>` : ''}
                            <div class="session-actions">
                                ${session.status === 'pending' ? `
                                    <button class="btn btn-success" onclick="updateSessionStatus('${session.id}', 'confirmed')">Confirm</button>
                                    <button class="btn btn-danger" onclick="updateSessionStatus('${session.id}', 'cancelled')">Cancel</button>
                                ` : ''}
                                ${session.status === 'confirmed' ? `
                                    <button class="btn btn-success" onclick="updateSessionStatus('${session.id}', 'completed')">Mark Complete</button>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load sessions:', error);
            }
        }

        async function updateSessionStatus(sessionId, status) {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                const data = await response.json();

                if (data.success) {
                    loadSessions();
                    showAlert('Session status updated', 'success');
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to update session status', 'error');
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 3000);
        }

        loadMySkills();
    </script>
</body>
</html>
